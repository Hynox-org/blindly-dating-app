name: Supabase CI

on:
    push:
        branches:
            - main
            - dev
    pull_request:
        branches:
            - main
            - dev

jobs:
    supabase_ci:
        runs-on: ubuntu-latest

        permissions:
            contents: read
            pull-requests: write

        steps:
            - uses: actions/checkout@v3

            - uses: supabase/setup-cli@v1
              with:
                  version: latest

            - name: Start Supabase (Local)
              run: supabase start

            - name: Verify Generated Types
              run: |
                  supabase gen types typescript --local > database.types.ts
                  # Ideally, you check if this diffs from committed types

            - name: Deploy to Supabase
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              # Only deploy migrations on push to main
              # (The Supabase GitHub App handles 'dev' and other preview branches automatically)
              run: |
                  supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --password ${{ secrets.SUPABASE_DB_PASSWORD }}
                  supabase db push

env:
    SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
    SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
